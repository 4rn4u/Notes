# R-Services

R-Services are a suite of services designed to enable remote access or execute commands between Unix hosts over TCP/IP. Initially developed by the Computer Systems Research Group (CSRG) at the University of California, Berkeley, r-services were the standard for remote access between Unix operating systems until they were replaced by Secure Shell (SSH) protocols due to inherent security flaws. Similar to telnet, r-services transmit information unencrypted, making it possible for attackers to intercept network traffic, including passwords and login information, through man-in-the-middle (MITM) attacks.

## Ports and Accessibility

R-services operate over ports 512, 513, and 514 and are accessed through a suite of programs known as r-commands. While less common today, they are still encountered occasionally during internal penetration tests, making it important to understand their operation.

## R-Commands Suite

The r-commands suite includes:

- `rcp` (remote copy)
- `rexec` (remote execution)
- `rlogin` (remote login)
- `rsh` (remote shell)
- `rstat`
- `ruptime`
- `rwho` (remote who)

### Frequently Abused R-Commands

Here is an overview of the most frequently abused r-commands, including the service daemon they interact with, the port and transport method, and a brief description of each:

| Command | Service Daemon | Port | Transport Protocol | Description |
|---------|----------------|------|--------------------|-------------|
| `rcp`   | `rshd`         | 514  | TCP                | Copies a file or directory bidirectionally between the local system and a remote system or between two remote systems. Similar to the `cp` command but provides no warning for overwriting existing files. |
| `rsh`   | `rshd`         | 514  | TCP                | Opens a shell on a remote machine without a login procedure, relying on trusted entries in `/etc/hosts.equiv` and `.rhosts` for validation. |
| `rexec` | `rexecd`       | 512  | TCP                | Allows a user to run shell commands on a remote machine. Requires authentication with a username and password through an unencrypted network socket, overridden by trusted entries in `/etc/hosts.equiv` and `.rhosts`. |
| `rlogin`| `rlogind`      | 513  | TCP                | Enables a user to log in to a remote host over the network, similar to telnet but only for Unix-like hosts. Authentication is overridden by trusted entries in `/etc/hosts.equiv` and `.rhosts`. |

## Security Considerations

Due to their lack of encryption and reliance on outdated authentication mechanisms, r-services pose significant security risks. They should be replaced by more secure protocols like SSH whenever possible to ensure secure communication and prevent unauthorized access.

The /etc/hosts.equiv file contains a list of trusted hosts and is used to grant access to other systems on the network. When users on one of these hosts attempt to access the system, they are automatically granted access without further authentication.
#### /etc/hosts.equiv

  Linux Remote Management Protocols

```shell-session
4rn4u@htb[/htb]$ cat /etc/hosts.equiv

# <hostname> <local username>
pwnbox cry0l1t3
```

#### Scanning for R-Services
```shell-session
$ sudo nmap -sV -p 512,513,514 10.0.17.2
```

# Access Control & Trusted Relationships

## Access Control Concerns

The primary concern with r-services, and a key reason for the introduction of SSH, is the inherent issues with access control. R-services depend on trusted information sent from the remote client to the host machine for authentication. By default, these services use Pluggable Authentication Modules (PAM) for user authentication on a remote system. However, they can bypass this authentication using the `/etc/hosts.equiv` and `.rhosts` files.
## Trusted Relationships

The `/etc/hosts.equiv` and `.rhosts` files contain lists of hosts (IPs or Hostnames) and users that the local host trusts when a connection attempt is made using r-commands. Entries in these files might look like this:
#### Sample .rhosts File
```shell-session
cat .rhosts
```
Both the `/etc/hosts.equiv` and `.rhosts` files use a specific syntax, consisting of `<username> <ip address>` or `<username> <hostname>` pairs. Additionally, the `+` modifier can act as a wildcard, allowing broader access permissions. For instance, using the `+` modifier in the file can permit any external user to access r-commands from the `htb-student` user account via the host with the IP address `10.0.17.10`.

#### Logging in Using Rlogin
```shell-session
$ rlogin 10.0.17.2 -l htb-student
```
We have successfully logged in under the `htb-student` account on the remote host due to the misconfigurations in the `.rhosts` file. Once successfully logged in, we can also abuse the `rwho` command to list all interactive sessions on the local network by sending requests to the UDP port 513.

#### Listing Authenticated Users Using Rwho
```shell-session
$ rwho
```

#### Listing Authenticated Users Using Rusers
```shell-session
$ rusers -al 10.0.17.5
```