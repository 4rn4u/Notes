
# Firewall and IDS/IPS Evasion

Nmap provides various techniques to bypass firewall rules and IDS/IPS systems, including packet fragmentation, the use of decoys.

## Firewalls

A firewall is a security measure against unauthorized connection attempts from external networks. It monitors network traffic and decides how to handle connections based on predefined rules. Firewalls check whether individual network packets should be passed, ignored, or blocked, thus preventing unwanted connections that could be potentially dangerous.

## IDS/IPS

Intrusion Detection Systems (IDS) and Intrusion Prevention Systems (IPS) are software-based components similar to firewalls. IDS scans the network for potential attacks, analyzes them, and reports any detected attacks. IPS complements IDS by taking specific defensive measures if a potential attack is detected. They analyze attacks based on pattern matching and signatures, preventing pending connection attempts if specific patterns are detected.

## Determine Firewalls and Their Rules

When a port is shown as filtered, it may be due to firewall rules. Firewalls can either drop or reject packets:
- **Dropped packets**: Ignored with no response from the host.
- **Rejected packets**: Returned with an RST flag, ICMP error codes, or no content.

Common ICMP error codes include:
- Net Unreachable
- Net Prohibited
- Host Unreachable
- Host Prohibited
- Port Unreachable
- Proto Unreachable

Nmap's TCP ACK scan (`-sA`) is harder for firewalls and IDS/IPS systems to filter compared to regular SYN (`-sS`) or Connect scans (`-sT`). The ACK scan sends TCP packets with only the ACK flag. For both open and closed ports, the host must respond with an RST flag. Unlike SYN flag connection attempts, which are often blocked by firewalls, ACK flag packets frequently pass through because firewalls cannot determine whether the connection was established from the external or internal network.

By analyzing these scans, we can observe how the results differ and gain insights into the presence and rules of firewalls and IDS/IPS systems.

# Detect IDS/IPS

Detecting IDS/IPS systems is more challenging than detecting firewalls because IDS/IPS are passive traffic monitoring systems. IDS (Intrusion Detection Systems) monitor all connections between hosts, notifying the administrator if they detect suspicious packets. IPS (Intrusion Prevention Systems) automatically take pre-configured actions to prevent attacks.

To identify the presence of IDS/IPS during a penetration test, using multiple Virtual Private Servers (VPS) with different IP addresses is recommended. If an attack is detected, the administrator may block the IP address, preventing further access. This can indicate the presence of such systems.

Administrators may implement security measures in response to aggressive scanning. By observing these measures, penetration testers can infer the presence of monitoring systems. Scanning from a single host (VPS) and observing if it gets blocked can also indicate IPS activity.

If a block occurs, testers should switch to another VPS and proceed more quietly, disguising their interactions to avoid detection.

## SYN vs ACK

```shell-session
$ sudo nmap 10.129.2.28 -p 21,22,25 -sS -Pn -n --disable-arp-ping --packet-trace

Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-21 14:56 CEST
SENT (0.0278s) TCP 10.10.14.2:57347 > 10.129.2.28:22 S ttl=53 id=22412 iplen=44  seq=4092255222 win=1024 <mss 1460>
SENT (0.0278s) TCP 10.10.14.2:57347 > 10.129.2.28:25 S ttl=50 id=62291 iplen=44  seq=4092255222 win=1024 <mss 1460>
SENT (0.0278s) TCP 10.10.14.2:57347 > 10.129.2.28:21 S ttl=58 id=38696 iplen=44  seq=4092255222 win=1024 <mss 1460>
RCVD (0.0329s) ICMP [10.129.2.28 > 10.10.14.2 Port 21 unreachable (type=3/code=3) ] IP [ttl=64 id=40884 iplen=72 ]
RCVD (0.0341s) TCP 10.129.2.28:22 > 10.10.14.2:57347 SA ttl=64 id=0 iplen=44  seq=1153454414 win=64240 <mss 1460>
RCVD (1.0386s) TCP 10.129.2.28:22 > 10.10.14.2:57347 SA ttl=64 id=0 iplen=44  seq=1153454414 win=64240 <mss 1460>
SENT (1.1366s) TCP 10.10.14.2:57348 > 10.129.2.28:25 S ttl=44 id=6796 iplen=44  seq=4092320759 win=1024 <mss 1460>
Nmap scan report for 10.129.2.28
Host is up (0.0053s latency).

PORT   STATE    SERVICE
21/tcp filtered ftp
22/tcp open     ssh
25/tcp filtered smtp
MAC Address: DE:AD:00:00:BE:EF (Intel Corporate)

Nmap done: 1 IP address (1 host up) scanned in 0.07 seconds
```

```shell-session
$ sudo nmap 10.129.2.28 -p 21,22,25 -sA -Pn -n --disable-arp-ping --packet-trace

Starting Nmap 7.80 ( https://nmap.org ) at 2020-06-21 14:57 CEST
SENT (0.0422s) TCP 10.10.14.2:49343 > 10.129.2.28:21 A ttl=49 id=12381 iplen=40  seq=0 win=1024
SENT (0.0423s) TCP 10.10.14.2:49343 > 10.129.2.28:22 A ttl=41 id=5146 iplen=40  seq=0 win=1024
SENT (0.0423s) TCP 10.10.14.2:49343 > 10.129.2.28:25 A ttl=49 id=5800 iplen=40  seq=0 win=1024
RCVD (0.1252s) ICMP [10.129.2.28 > 10.10.14.2 Port 21 unreachable (type=3/code=3) ] IP [ttl=64 id=55628 iplen=68 ]
RCVD (0.1268s) TCP 10.129.2.28:22 > 10.10.14.2:49343 R ttl=64 id=0 iplen=40  seq=1660784500 win=0
SENT (1.3837s) TCP 10.10.14.2:49344 > 10.129.2.28:25 A ttl=59 id=21915 iplen=40  seq=0 win=1024
Nmap scan report for 10.129.2.28
Host is up (0.083s latency).

PORT   STATE      SERVICE
21/tcp filtered   ftp
22/tcp unfiltered ssh
25/tcp filtered   smtp
MAC Address: DE:AD:00:00:BE:EF (Intel Corporate)

Nmap done: 1 IP address (1 host up) scanned in 0.15 seconds
```

The received (RCVD) packets and the flags set on them from our target. With the SYN scan (`-sS`), the target attempts to establish a TCP connection by sending back a packet with the SYN-ACK (SA) flags set. With the ACK scan (`-sA`), we receive an RST flag, indicating that TCP port 22 is open. For TCP port 25, no packets are received back, indicating that the packets are being dropped.

## Scan by Using Different Source IP

```shell-session
$ sudo nmap 10.129.2.28 -n -Pn -p 445 -O -S 10.129.2.200 -e tun0
```


## DNS Proxying

By default, Nmap performs a reverse DNS resolution to gather more information about the target unless otherwise specified. These DNS queries usually pass through because the web server is intended to be found and visited. DNS queries are typically made over UDP port 53. Historically, TCP port 53 was used for "Zone transfers" between DNS servers or for data transfers larger than 512 bytes. However, with the adoption of IPv6 and DNSSEC, many DNS requests now use TCP port 53.

Nmap allows users to specify DNS servers using the `--dns-server <ns>,<ns>` option. This can be crucial in a demilitarized zone (DMZ) where company DNS servers are more trusted than those on the Internet, enabling interaction with internal network hosts. Additionally, TCP port 53 can be used as a source port (`--source-port`) for scans. If a firewall administrator does not properly filter IDS/IPS on this port, TCP packets may be trusted 

#### SYN-Scan From DNS Port
```shell-session
$ sudo nmap 10.129.2.28 -p50000 -sS -Pn -n --disable-arp-ping --packet-trace --source-port 53
```

```shell-session
$ ncat -nv --source-port 53 10.129.2.28 50000
```