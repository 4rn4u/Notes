# **SMTP**

## **Simple mail transfer protocol 25, or 465,587**

The Simple Mail Transfer Protocol (SMTP) is used for sending emails within an IP network. It operates between an email client and an outgoing mail server or between two SMTP servers. SMTP is often paired with IMAP or POP3, which handle fetching and sending emails. Although SMTP is fundamentally a client-server-based protocol, it can be used both between a client and a server and between two SMTP servers, where one server acts as a client.

## Default and Alternative Ports

SMTP servers typically accept connections on port 25. However, newer SMTP servers also use ports like TCP port 587, which is employed to receive mail from authenticated users or servers. This often involves the STARTTLS command to switch from a plaintext to an encrypted connection, protecting authentication data from being visible in plaintext over the network.

## Connection and Authentication

At the start of the connection, the client authenticates itself with a username and password. The client then sends the server the sender and recipient addresses, the email's content, and other parameters. Once the email is transmitted, the connection is terminated, and the email server forwards the email to another SMTP server.

## Encryption and Security

SMTP transmits all commands, data, and authentication information in plain text unless additional encryption measures are used. To prevent unauthorized data access, SMTP can be used with SSL/TLS encryption, often on ports other than the default TCP port 25, such as TCP port 465.

An essential function of an SMTP server is spam prevention. This is achieved using authentication mechanisms that allow only authorized users to send emails. Modern SMTP servers often support the ESMTP protocol extension with SMTP-Auth. After an email is sent, the SMTP client, also known as a Mail User Agent (MUA), converts it into a header and a body and uploads both to the SMTP server, which uses a Mail Transfer Agent (MTA) for sending and receiving emails. The MTA checks the email for size and spam before storing it. Sometimes, a Mail Submission Agent (MSA) precedes the MTA to verify the email's origin. This MSA, or Relay server, is crucial as misconfigured SMTP servers can be vulnerable to Open Relay Attacks.

## Email Delivery Process

When an email reaches the destination SMTP server, data packets are reassembled into a complete email. The Mail Delivery Agent (MDA) then transfers it to the recipient's mailbox.

Email flow: Client (MUA) ➞ Submission Agent (MSA) ➞ Open Relay (MTA) ➞ Mail Delivery Agent (MDA) ➞ Mailbox (POP3/IMAP)

## Disadvantages of SMTP

SMTP has two main disadvantages:
1. **Lack of Delivery Confirmation**: SMTP does not guarantee a usable delivery confirmation. While the protocol specifications include this feature, the formatting is not standardized, usually resulting in an English-language error message.
2. **Lack of Sender Authentication**: SMTP does not authenticate users when establishing a connection, making the sender of an email unreliable. This can lead to open SMTP relays being misused to send spam. Spammers often use fake sender addresses to avoid being traced (mail spoofing).

To combat these issues, various security techniques are employed, such as rejecting or quarantining suspicious emails. Protocols like DomainKeys (DKIM) and the Sender Policy Framework (SPF) are used for identification.

## Extended SMTP (ESMTP)
An extension of SMTP, called Extended SMTP (ESMTP), addresses some of these issues. When people refer to SMTP, they often mean ESMTP. ESMTP uses TLS after the EHLO command by sending STARTTLS, initializing an SSL-protected SMTP connection. From this point, the connection is encrypted and secure, allowing for the safe use of the AUTH PLAIN extension for authentication.

--------------------------------------------------------------------

To interact with the SMTP server, we can use the `telnet` tool to initialize a TCP connection with the SMTP server. The actual initialization of the session is done with the command mentioned above, `HELO` or `EHLO`.

```shell-session
$ telnet 10.129.14.128 25
```
#### Telnet - VRFY
```shell-session
telnet 10.129.14.128 25
```
```shell-session
VRFY root
VRFY cry0l1t3
```

Sometimes we may have to work through a web proxy. We can also make this web proxy connect to the SMTP server. The command that we would send would then look something like this: `CONNECT 10.129.14.128:25 HTTP/1.0`

#### Send an Email
```shell-session
telnet 10.129.14.128 25
EHLO inlanefreight.htb
MAIL FROM: <cry0l1t3@inlanefreight.htb>
RCPT TO: <mrb3n@inlanefreight.htb> NOTIFY=success,failure
DATA
QUIT
```

#### Open Relay Configuration

  SMTP

```shell-session
mynetworks = 0.0.0.0/0
```

With this setting, the SMTP server can send fake emails, initiating communication between multiple parties. Additionally, another attack vector is email spoofing, where the attacker can send emails that appear to be from a legitimate source and potentially intercept and read the email content.

# Footprinting

```shell-session
$ sudo nmap 10.129.14.128 -sC -sV -p25
```
```shell-session
$ sudo nmap 10.129.14.128 -p25 --script smtp-open-relay -v
```
```shell-session
$ smtp-user-enum -M VRFY -u list.txt -t 10.129.32.56 -w 15 -v

```
--------------------------------------------------------------------
### Metasploit

```
$ msfconsole 

> auxiliary/scanner/smtp/...
```

--------------------------------------------------------------------